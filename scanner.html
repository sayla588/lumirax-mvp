
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能合约扫描 (真实版) - ChainGuard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* 保持原有样式不变 */
        .check-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .check-item:last-child { border-bottom: none; }
        .check-label { display: flex; align-items: center; gap: 10px; }
        
        /* 状态颜色 */
        .status-pass { color: var(--accent-green); }
        .status-warn { color: #f59e0b; }
        .status-fail { color: var(--accent-red); }
        .status-unknown { color: var(--text-gray); }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .fa-spinner {
            font-size: 3rem;
            color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* 错误提示框 */
        .error-box {
            display: none;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo"><i class="fa-solid fa-shield-halved"></i> ChainGuard</div>
        <ul class="nav-links">
            <li><a href="index.html">首页</a></li>
            <li><a href="scanner.html" class="active">链上扫描</a></li>
            <li><a href="risk.html">风险透视</a></li>
            <li><a href="verify.html">验证工具</a></li>
        </ul>
        <div class="nav-actions">
            <button class="btn-login">登录 / 注册</button>
        </div>
        <div class="hamburger"><i class="fa-solid fa-bars"></i></div>
    </nav>

    <div class="page-container">
        <div class="tool-header">
            <h1>智能合约安全扫描 (Ethereum)</h1>
            <p>连接 GoPlus Security API，获取实时链上安全数据。</p>
        </div>

        <div class="tool-box">
            <div class="input-group">
                <!-- 默认填入一个USDT地址方便测试 -->
                <input type="text" class="main-input" id="contractInput" placeholder="输入以太坊合约地址 (如: 0xdac17...)" value="0xdac17f958d2ee523a2206206994597c13d831ec7">
                <button class="btn-action" onclick="startRealScan()">开始扫描</button>
            </div>

            <div class="error-box" id="errorBox"></div>

            <div class="loading-spinner" id="loading">
                <i class="fa-solid fa-spinner"></i>
                <p style="margin-top: 1rem; color: var(--text-gray);">正在连接区块链节点分析数据...</p>
            </div>

            <div class="result-area" id="result">
                <div class="score-display">
                    <div class="score-circle" id="scoreCircle">--</div>
                    <h3>安全评分: <span id="scoreText">计算中</span></h3>
                    <p style="color: var(--text-gray); font-size: 0.9rem;">代币名称: <span id="tokenName" style="color:white">--</span></p>
                </div>

                <div class="result-card">
                    <h4><i class="fa-solid fa-list-check"></i> 核心检测项</h4>
                    
                    <!-- 开源检测 -->
                    <div class="check-item">
                        <div class="check-label">
                            <i class="fa-solid fa-code" id="icon-opensource"></i>
                            <span>合约开源 (Open Source)</span>
                        </div>
                        <span id="val-opensource">--</span>
                    </div>

                    <!-- 貔貅检测 -->
                    <div class="check-item">
                        <div class="check-label">
                            <i class="fa-solid fa-bug" id="icon-honeypot"></i>
                            <span>貔貅盘检测 (Honeypot)</span>
                        </div>
                        <span id="val-honeypot">--</span>
                    </div>

                    <!-- 交易税 -->
                    <div class="check-item">
                        <div class="check-label">
                            <i class="fa-solid fa-money-bill-wave" id="icon-tax"></i>
                            <span>交易税率 (Buy/Sell Tax)</span>
                        </div>
                        <span id="val-tax">--</span>
                    </div>

                    <!-- 代理合约 -->
                    <div class="check-item">
                        <div class="check-label">
                            <i class="fa-solid fa-user-secret" id="icon-proxy"></i>
                            <span>代理合约 (Proxy)</span>
                        </div>
                        <span id="val-proxy">--</span>
                    </div>
                </div>

                <div class="result-card">
                    <h4><i class="fa-solid fa-robot"></i> 简要分析</h4>
                    <p id="ai-summary" style="color: #cbd5e1; font-size: 0.9rem; margin-top: 0.5rem;">
                        等待扫描结果...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-logo"><i class="fa-solid fa-shield-halved"></i> ChainGuard</div>
            <p>&copy; 2023 ChainGuard Security. Powered by GoPlus API.</p>
        </div>
    </footer>

    <script>
        const hamburger = document.querySelector('.hamburger');
        const navLinks = document.querySelector('.nav-links');
        hamburger.addEventListener('click', () => navLinks.classList.toggle('active'));

        // 真实扫描逻辑
        async function startRealScan() {
            const input = document.getElementById('contractInput').value.trim();
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const errorBox = document.getElementById('errorBox');

            // 重置界面
            result.style.display = 'none';
            errorBox.style.display = 'none';
            
            if(!input.startsWith('0x') || input.length !== 42) {
                showError("请输入有效的以太坊合约地址（0x开头，42位字符）");
                return;
            }

            loading.style.display = 'block';

            try {
                // 调用 GoPlus Security API (Chain ID 1 = Ethereum Mainnet)
                const response = await fetch(`https://api.gopluslabs.io/api/v1/token_security/1?contract_addresses=${input}`);
                const json = await response.json();

                loading.style.display = 'none';

                if (json.code !== 1 || !json.result[input.toLowerCase()]) {
                    showError("未找到该代币信息，或 API 请求失败。请确认地址属于以太坊主网。");
                    return;
                }

                const data = json.result[input.toLowerCase()];
                displayData(data);
                result.style.display = 'block';
                result.scrollIntoView({ behavior: 'smooth' });

            } catch (err) {
                loading.style.display = 'none';
                console.error(err);
                showError("网络请求失败，请检查您的网络连接。");
            }
        }

        function displayData(data) {
            // 1. 基础信息
            document.getElementById('tokenName').innerText = data.token_name + " (" + data.token_symbol + ")";

            // 2. 开源检测
            const isOpenSource = data.is_open_source === "1";
            updateItem('opensource', isOpenSource, isOpenSource ? "已开源" : "未开源", true);

            // 3. 貔貅检测 (is_honeypot: "1" 是貔貅)
            const isHoneypot = data.is_honeypot === "1";
            updateItem('honeypot', !isHoneypot, isHoneypot ? "发现貔貅风险!" : "未发现貔貅代码", true);

            // 4. 税率
            const buyTax = (parseFloat(data.buy_tax) * 100).toFixed(1) + "%";
            const sellTax = (parseFloat(data.sell_tax) * 100).toFixed(1) + "%";
            const taxText = `买: ${buyTax} / 卖: ${sellTax}`;
            // 如果税率超过 10% 警告
            const isHighTax = parseFloat(data.buy_tax) > 0.1 || parseFloat(data.sell_tax) > 0.1;
            updateItem('tax', !isHighTax, taxText, false);

            // 5. 代理合约
            const isProxy = data.is_proxy === "1";
            updateItem('proxy', !isProxy, isProxy ? "存在代理 (可升级)" : "无代理", false);

            // 6. 计算简单评分
            let score = 100;
            if (!isOpenSource) score -= 30;
            if (isHoneypot) score = 0;
            if (isHighTax) score -= 20;
            if (isProxy) score -= 10;

            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.innerText = score;
            
            // 动态改变分数颜色
            if(score >= 80) {
                scoreCircle.style.borderColor = "var(--accent-green)";
                scoreCircle.style.color = "var(--accent-green)";
                document.getElementById('scoreText').innerText = "安全";
                document.getElementById('scoreText').style.color = "var(--accent-green)";
            } else if (score >= 50) {
                scoreCircle.style.borderColor = "#f59e0b";
                scoreCircle.style.color = "#f59e0b";
                document.getElementById('scoreText').innerText = "中等风险";
                document.getElementById('scoreText').style.color = "#f59e0b";
            } else {
                scoreCircle.style.borderColor = "var(--accent-red)";
                scoreCircle.style.color = "var(--accent-red)";
                document.getElementById('scoreText').innerText = "高风险";
                document.getElementById('scoreText').style.color = "var(--accent-red)";
            }

            // 7. 生成总结
            let summary = "";
            if(isHoneypot) {
                summary = "⚠️ 极度危险！检测到貔貅代码，该代币只能买入无法卖出。请绝对不要交易！";
            } else if (!isOpenSource) {
                summary = "⚠️ 风险较高。合约代码未开源，无法验证内部逻辑，存在隐藏后门的可能。";
            } else {
                summary = `合约已开源。当前交易税率为 ${taxText}。${isProxy ? "注意：该合约包含代理模式，管理员可能升级合约逻辑。" : "合约逻辑相对固定。"} 总体评分 ${score} 分。`;
            }
            document.getElementById('ai-summary').innerText = summary;
        }

        function updateItem(id, isGood, text, isCritical) {
            const valEl = document.getElementById(`val-${id}`);
            const iconEl = document.getElementById(`icon-${id}`);
            
            valEl.innerText = text;
            
            // 移除旧类
            valEl.classList.remove('status-pass', 'status-warn', 'status-fail');
            iconEl.classList.remove('status-pass', 'status-warn', 'status-fail');

            if (isGood) {
                valEl.classList.add('status-pass');
                iconEl.classList.add('status-pass');
                iconEl.className = isCritical ? "fa-solid fa-check-circle" : iconEl.className;
            } else {
                valEl.classList.add(isCritical ? 'status-fail' : 'status-warn');
                iconEl.classList.add(isCritical ? 'status-fail' : 'status-warn');
                if(isCritical) iconEl.className = "fa-solid fa-triangle-exclamation";
            }
        }

        function showError(msg) {
            const errorBox = document.getElementById('errorBox');
            errorBox.innerText = msg;
            errorBox.style.display = 'block';
        }
    </script>
</body>
</html>
